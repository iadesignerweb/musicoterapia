<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WiFire Painel Admin</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background: #121212; color:#eee; }
  #loginModal, #newUserModal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center;
    z-index: 1000;
  }
  #loginModal > div, #newUserModal > div {
    background:#222; padding:20px; border-radius:8px; width:320px;
  }
  input[type=password], input[type=text], select {
    width: 100%; padding: 10px; margin-top:8px; margin-bottom:12px; border-radius:5px; border:none;
    font-size: 1rem; background:#333; color:#eee;
  }
  button {
    background: #ff6b6b; border:none; padding: 10px 15px; color:#fff; border-radius:5px; cursor:pointer;
    font-weight: bold;
  }
  button:hover { background: #ff4b4b; }
  #sidebar {
    width: 250px; background: #1e1e1e; height: 100vh; position: fixed; top:0; left:0; padding-top: 60px;
    display: flex; flex-direction: column;
  }
  #sidebar button {
    background: none; border:none; color:#bbb; padding: 12px 20px; text-align:left; width: 100%;
    font-size: 1rem; cursor:pointer;
  }
  #sidebar button.active, #sidebar button:hover {
    background: #ff6b6b; color:#fff;
  }
  #content {
    margin-left: 250px; padding: 20px;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top:10px;
  }
  th, td {
    padding:8px; border-bottom:1px solid #444; font-size: 0.9rem;
  }
  th { background: #222; }
  .badge {
    padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;
  }
  .badge.active { background: #4CAF50; color: #fff; }
  .badge.inactive { background: #ccc; color: #444; }
  .conv-item {
    display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; cursor:pointer;
  }
  .conv-item:hover, .conv-item.selected {
    background: #333;
  }
  .avatar {
    background: #ff6b6b; color:#fff; font-weight:bold; font-size:1.2rem;
    width: 35px; height: 35px; border-radius: 50%; display:flex; justify-content:center; align-items:center;
    margin-right: 10px;
  }
  #messagesArea {
    height: 350px; background:#1c1c1c; padding:10px; overflow-y: auto; border-radius: 8px; margin-top:10px;
    color:#eee;
  }
  .msg {
    margin-bottom: 12px; max-width: 75%; padding: 8px 12px; border-radius: 10px;
  }
  .msg.user {
    background: #ff6b6b; color: #fff; margin-left: auto;
  }
  .msg.other {
    background: #333; color: #ccc; margin-right: auto;
  }
  #chatInput {
    width: calc(100% - 90px); padding: 10px; font-size: 1rem; border-radius: 6px; border:none; margin-top: 10px;
    background: #222; color:#eee;
  }
  #sendBtn {
    width: 70px; margin-left: 10px; background: #ff6b6b; border:none; border-radius: 6px; cursor:pointer; font-weight: bold;
  }
  #sendBtn:hover {
    background: #ff4b4b;
  }
  #loginError {
    color: #ff4b4b; font-weight: bold; margin-top: 8px; display: none;
  }
</style>
</head>
<body>

<!-- Modal Login -->
<div id="loginModal">
  <div>
    <h2>Login Administrativo</h2>
    <input id="adminInput" type="password" placeholder="Senha" autocomplete="off" />
    <button onclick="login()">Entrar</button>
    <div id="loginError">Senha incorreta.</div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" style="display:none;">
  <button class="active" data-view="dashboard" onclick="switchView('dashboard')">Dashboard</button>
  <button data-view="users" onclick="switchView('users')">Usuários</button>
  <button data-view="subscriptions" onclick="switchView('subscriptions')">Assinaturas</button>
  <button data-view="chat" onclick="switchView('chat')">Chat</button>
  <button onclick="logout()" style="margin-top:auto; color:#ff6b6b; font-weight:bold;">Sair</button>
</div>

<!-- Main Content -->
<div id="content" style="margin-left:0; display:none;">
  <!-- Views -->
  <section id="view-dashboard" class="view">
    <h2>Dashboard</h2>
    <div>Usuários Ativos: <span id="statActive"></span></div>
    <div>Assinantes Premium: <span id="statSubs"></span></div>
    <div>Total de Usuários: <span id="totalUsers"></span></div>
  </section>

  <section id="view-users" class="view" style="display:none;">
    <h2>Usuários</h2>
    <input type="text" id="searchInput" placeholder="Buscar usuários..." style="width:100%; padding:10px; border-radius:5px; border:none; margin-bottom:10px; background:#222; color:#eee;"/>
    <table id="usersTable">
      <thead>
        <tr><th>Nome</th><th>Telefone</th><th>Plano</th><th>Status</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="openNewUser()" style="margin-top:10px;">Novo Usuário</button>
  </section>

  <section id="view-subscriptions" class="view" style="display:none;">
    <h2>Assinaturas</h2>
    <div id="subsList"></div>
  </section>

  <section id="view-chat" class="view" style="display:none;">
    <h2>Chat</h2>
    <div id="conversationsList" style="max-height: 200px; overflow-y: auto; background:#222; padding:5px; border-radius:5px; margin-bottom:10px;"></div>
    <div id="messagesArea"></div>
    <div style="display:flex; margin-top:10px;">
      <input id="chatInput" type="text" placeholder="Digite sua mensagem" autocomplete="off" />
      <button id="sendBtn" onclick="sendMessage()">Enviar</button>
    </div>
  </section>
</div>

<!-- Modal Novo Usuário -->
<div id="newUserModal" style="display:none;">
  <div>
    <h3>Usuário</h3>
    <input id="nuName" type="text" placeholder="Nome" autocomplete="off" />
    <input id="nuNumber" type="text" placeholder="Telefone" autocomplete="off" />
    <select id="nuPlan">
      <option value="gratuito">Gratuito</option>
      <option value="mensal">Mensal</option>
      <option value="anual">Anual</option>
    </select>
    <select id="nuStatus">
      <option value="active">Ativo</option>
      <option value="inactive">Inativo</option>
    </select>
    <div style="margin-top:15px;">
      <button class="btn" onclick="saveUser()">Salvar</button>
      <button onclick="closeNewUser()" style="margin-left:10px; background:#666;">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  // Configurações e armazenamento local
  const STORAGE_KEYS = { users:'wf_users_v1', convs:'wf_convs_v1', settings:'wf_settings_v1' };
  let socket = null;
  let SOCKET_ENDPOINT = ''; // configure seu endpoint real aqui ou no localStorage

  // Dados em localStorage para demo, substitua conforme backend
  function seedData() {
    if (!localStorage.getItem(STORAGE_KEYS.users)) {
      const users = [
        {id:1, nome:'João Silva', numero:'87999990001', plano:'mensal', status:'active', created:Date.now()-86400000*5},
        {id:2, nome:'Maria Souza', numero:'87999990002', plano:'anual', status:'active', created:Date.now()-86400000*12},
        {id:3, nome:'Carlos Lima', numero:'87999990003', plano:'gratuito', status:'inactive', created:Date.now()-86400000*2}
      ];
      localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
    }
    if (!localStorage.getItem(STORAGE_KEYS.convs)) {
      const convs = [
        {id:101,userId:1, last:'Quero renovar plano', unread:1, messages:[
          {from:'user', text:'Olá, quero renovar meu plano', time:Date.now()-60000},
          {from:'admin', text:'Posso ajudar. Qual o plano?', time:Date.now()-30000}
        ]},
        {id:102,userId:2, last:'Pedido de suporte', unread:0, messages:[
          {from:'user', text:'Não consigo conectar', time:Date.now()-3600000}
        ]}
      ];
      localStorage.setItem(STORAGE_KEYS.convs, JSON.stringify(convs));
    }
    if (!localStorage.getItem(STORAGE_KEYS.settings)) {
      const settings = { socketEndpoint:'http://localhost:3000', adminPass:'wifire2025' };
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings));
    }
  }
  seedData();

  // Helpers localStorage
  function readUsers(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.users) || '[]'); }
  function saveUsers(u){ localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(u)); }
  function readConvs(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.convs) || '[]'); }
  function saveConvs(c){ localStorage.setItem(STORAGE_KEYS.convs, JSON.stringify(c)); }
  function readSettings(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.settings) || '{}'); }
  function saveSettings(s){ localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(s)); }

  // Estado atual
  let currentAdmin = null;
  let selectedConvId = null;
  let editingUserId = null;

  // Login
  function login(){
    const pw = document.getElementById('adminInput').value.trim();
    const settings = readSettings();
    if(pw === (settings.adminPass || 'wifire2025')){
      currentAdmin = { name:'Admin' };
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('sidebar').style.display = 'flex';
      document.getElementById('content').style.display = 'block';
      document.getElementById('loginError').style.display = 'none';
      initPanel();
    } else {
      const el = document.getElementById('loginError');
      el.style.display = 'block';
      el.textContent = 'Senha incorreta.';
    }
  }
  // Logout
  function logout(){
    currentAdmin = null;
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('sidebar').style.display = 'none';
    document.getElementById('content').style.display = 'none';
  }

  // Trocar views
  function switchView(view){
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById('view-'+view).style.display = 'block';
    document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('active'));
    document.querySelector(`#sidebar button[data-view="${view}"]`).classList.add('active');
    if(view === 'users') renderUsersTable();
    if(view === 'subscriptions') renderSubscriptions();
    if(view === 'chat') renderConversations();
  }

  // Inicializa painel após login
  function initPanel(){
    const s = readSettings();
    SOCKET_ENDPOINT = s.socketEndpoint || '';
    if(SOCKET_ENDPOINT){
      connectSocket(SOCKET_ENDPOINT);
    }
    switchView('dashboard');
    renderUsersTable();
    renderSubscriptions();
    updateStats();
  }

  // Conectar Socket.IO
  function connectSocket(endpoint){
    if(socket) socket.disconnect();
    socket = io(endpoint);
    socket.on('connect', () => {
      console.log('Conectado ao Socket.IO');
      socket.emit('sync:request');
    });
    socket.on('users:update', (users) => {
      saveUsers(users);
      renderUsersTable();
      updateStats();
    });
    socket.on('convs:update', (convs) => {
      saveConvs(convs);
      renderConversations();
    });
    socket.on('message:new', ({convId, from, text, time}) => {
      let convs = readConvs();
      let conv = convs.find(c => c.id === convId);
      if(conv){
        conv.messages.push({from, text, time});
        conv.last = text;
        if(from === 'user') conv.unread = 1;
        saveConvs(convs);
        renderConversations();
        if(selectedConvId === convId) renderMessages(convId);
      }
    });
  }

  // Estatísticas Dashboard
  function updateStats(){
    const users = readUsers();
    const activeCount = users.filter(u => u.status === 'active').length;
    const subsCount = users.filter(u => (u.plano === 'mensal' || u.plano === 'anual') && u.status === 'active').length;
    document.getElementById('statActive').textContent = activeCount;
    document.getElementById('statSubs').textContent = subsCount;
    document.getElementById('totalUsers').textContent = users.length;
  }

  // Renderizar tabela usuários
  function renderUsersTable(){
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';
    const users = readUsers();
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.nome}</td>
        <td>${u.numero}</td>
        <td>${u.plano}</td>
        <td>${u.status === 'active' ? '<span class="badge active">Ativo</span>' : '<span class="badge inactive">Inativo</span>'}</td>
        <td>
          <button onclick="editUser(${u.id})">Editar</button>
          <button onclick="deleteUser(${u.id})">Remover</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Abrir modal novo usuário
  function openNewUser(){
    editingUserId = null;
    document.getElementById('nuName').value = '';
    document.getElementById('nuNumber').value = '';
    document.getElementById('nuPlan').value = 'gratuito';
    document.getElementById('nuStatus').value = 'active';
    document.getElementById('newUserModal').style.display = 'flex';
  }

  // Editar usuário
  function editUser(id){
    const users = readUsers();
    const u = users.find(x => x.id === id);
    if(!u) return alert('Usuário não encontrado');
    editingUserId = id;
    document.getElementById('nuName').value = u.nome;
    document.getElementById('nuNumber').value = u.numero;
    document.getElementById('nuPlan').value = u.plano;
    document.getElementById('nuStatus').value = u.status;
    document.getElementById('newUserModal').style.display = 'flex';
  }

  // Salvar usuário novo ou editado
  function saveUser(){
    const name = document.getElementById('nuName').value.trim();
    const number = document.getElementById('nuNumber').value.trim();
    const plan = document.getElementById('nuPlan').value;
    const status = document.getElementById('nuStatus').value;
    if(!name || !number){
      alert('Nome e telefone são obrigatórios.');
      return;
    }
    let users = readUsers();
    if(editingUserId){
      // editar
      const idx = users.findIndex(u => u.id === editingUserId);
      if(idx < 0) return alert('Usuário não encontrado');
      users[idx] = {...users[idx], nome:name, numero:number, plano:plan, status};
    } else {
      // novo
      const id = Date.now();
      users.push({id, nome:name, numero:number, plano:plan, status, created:Date.now()});
    }
    saveUsers(users);
    document.getElementById('newUserModal').style.display = 'none';
    renderUsersTable();
    renderSubscriptions();
    updateStats();
  }

  // Fechar modal novo usuário
  function closeNewUser(){
    document.getElementById('newUserModal').style.display = 'none';
  }

  // Remover usuário
  function deleteUser(id){
    if(!confirm('Deseja remover este usuário?')) return;
    let users = readUsers();
    users = users.filter(u => u.id !== id);
    saveUsers(users);
    renderUsersTable();
    renderSubscriptions();
    updateStats();
  }

  // Renderizar assinaturas
  function renderSubscriptions(){
    const dest = document.getElementById('subsList');
    dest.innerHTML = '';
    const users = readUsers().filter(u => u.status === 'active' && (u.plano === 'mensal' || u.plano === 'anual'));
    if(users.length === 0){
      dest.innerHTML = '<p>Nenhuma assinatura ativa encontrada.</p>';
      return;
    }
    users.forEach(u => {
      const div = document.createElement('div');
      div.textContent = `${u.nome} - ${u.plano} - ${u.numero}`;
      dest.appendChild(div);
    });
  }

  // Chat: renderizar lista conversas
  function renderConversations(){
    const convs = readConvs();
    const users = readUsers();
    const list = document.getElementById('conversationsList');
    list.innerHTML = '';
    convs.forEach(conv => {
      const user = users.find(u => u.id === conv.userId);
      const div = document.createElement('div');
      div.className = 'conv-item' + (conv.id === selectedConvId ? ' selected' : '');
      div.dataset.id = conv.id;
      div.onclick = () => {
        selectedConvId = conv.id;
        renderConversations();
        renderMessages(conv.id);
      };
      div.innerHTML = `
        <div style="display:flex; align-items:center;">
          <div class="avatar">${user ? user.nome.charAt(0).toUpperCase() : '?'}</div>
          <div>
            <div>${user ? user.nome : 'Desconhecido'}</div>
            <small>${conv.last || ''}</small>
          </div>
        </div>
        <div>${conv.unread ? '🆕' : ''}</div>
      `;
      list.appendChild(div);
    });
    if(selectedConvId && convs.find(c => c.id === selectedConvId)){
      renderMessages(selectedConvId);
    } else if(convs.length > 0){
      selectedConvId = convs[0].id;
      renderMessages(selectedConvId);
    } else {
      document.getElementById('messagesArea').innerHTML = '<p>Sem conversas.</p>';
    }
  }

  // Renderizar mensagens de uma conversa
  function renderMessages(convId){
    const convs = readConvs();
    const conv = convs.find(c => c.id === convId);
    if(!conv) return;
    conv.unread = 0; // limpa o status de não lida
    saveConvs(convs);
    renderConversations();
    const users = readUsers();
    const user = users.find(u => u.id === conv.userId);
    document.getElementById('chatTitle')?.innerText = user ? `Chat com ${user.nome}` : 'Chat';
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.innerHTML = '';
    conv.messages.forEach(m => {
      const div = document.createElement('div');
      div.className = 'msg ' + (m.from === 'user' ? 'user' : 'other');
      div.textContent = m.text;
      messagesArea.appendChild(div);
    });
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  // Enviar mensagem no chat
  function sendMessage(){
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if(!text || !selectedConvId) return;
    const convs = readConvs();
    const conv = convs.find(c => c.id === selectedConvId);
    if(!conv) return;
    const time = Date.now();
    conv.messages.push({from:'admin', text, time});
    conv.last = text;
    saveConvs(convs);
    input.value = '';
    renderMessages(selectedConvId);
    renderConversations();

    // Enviar via Socket.IO para backend
    if(socket && socket.connected){
      socket.emit('message:send', {
        convId: selectedConvId,
        from: 'admin',
        text,
        time
      });
    }
  }

  // Buscar usuários na tabela
  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
      const text = tr.textContent.toLowerCase();
      tr.style.display = text.includes(q) ? '' : 'none';
    });
  });

</script>

</body>
</html>
